# GitLab CI/CD é…ç½®
# è‡ªåŠ¨ä»£ç å®¡æŸ¥å’Œè´¨é‡æ£€æŸ¥

stages:
  - build
  - review
  - report

variables:
  CPP_STANDARD: "c++17"
  ENABLE_TAINT_ANALYSIS: "true"
  ENABLE_AI_SUGGESTIONS: "false"

# ç¼“å­˜ä¾èµ–ä»¥åŠ é€Ÿæž„å»º
cache:
  paths:
    - build/
    - .cache/

# æž„å»º cpp-agent
build:
  stage: build
  image: ubuntu:22.04
  before_script:
    - apt-get update -qq
    - apt-get install -y build-essential cmake llvm-14 llvm-14-dev clang-14 libclang-14-dev libcurl4-openssl-dev
  script:
    - mkdir -p build
    - cd build
    - cmake .. -DENABLE_CURL=ON -DCMAKE_BUILD_TYPE=Release
    - make -j$(nproc)
  artifacts:
    paths:
      - build/cpp-agent
    expire_in: 1 hour

# ä»£ç å®¡æŸ¥ - Merge Request
review:mr:
  stage: review
  image: ubuntu:22.04
  dependencies:
    - build
  only:
    - merge_requests
  before_script:
    - apt-get update -qq
    - apt-get install -y git
  script:
    - |
      if [ "$ENABLE_TAINT_ANALYSIS" = "true" ]; then
        TAINT_FLAG="--enable-taint-analysis"
      fi
    - |
      if [ "$ENABLE_AI_SUGGESTIONS" = "true" ]; then
        AI_FLAGS="--enable-ai --ai-provider=${AI_PROVIDER:-rule-based}"
        if [ -n "$OPENAI_API_KEY" ]; then
          AI_FLAGS="$AI_FLAGS --openai-key=$OPENAI_API_KEY"
        fi
        if [ -n "$ANTHROPIC_API_KEY" ]; then
          AI_FLAGS="$AI_FLAGS --anthropic-key=$ANTHROPIC_API_KEY"
        fi
      fi
    - ./build/cpp-agent --pr --pr-comment=mr-review.md --std=$CPP_STANDARD $TAINT_FLAG $AI_FLAGS || true
    - |
      if [ -f mr-review.md ]; then
        echo "ðŸ“Š ä»£ç å®¡æŸ¥æŠ¥å‘Š:"
        cat mr-review.md
      fi
  artifacts:
    reports:
      codequality: gl-code-quality-report.json
    paths:
      - mr-review.md
    expire_in: 30 days
  allow_failure: true

# ä»£ç å®¡æŸ¥ - Push
review:push:
  stage: review
  image: ubuntu:22.04
  dependencies:
    - build
  only:
    - branches
  except:
    - merge_requests
  before_script:
    - apt-get update -qq
    - apt-get install -y git
  script:
    - |
      if [ "$ENABLE_TAINT_ANALYSIS" = "true" ]; then
        TAINT_FLAG="--enable-taint-analysis"
      fi
    - ./build/cpp-agent --incremental --std=$CPP_STANDARD $TAINT_FLAG
  allow_failure: true

# å…¨é‡æ‰«æ (å®šæ—¶ä»»åŠ¡)
review:full:
  stage: review
  image: ubuntu:22.04
  dependencies:
    - build
  only:
    - schedules
  script:
    - ./build/cpp-agent scan . --std=$CPP_STANDARD --enable-taint-analysis --html-output=full-report.html
  artifacts:
    paths:
      - full-report.html
    expire_in: 90 days

# ç”ŸæˆæŠ¥å‘Š
report:
  stage: report
  image: ubuntu:22.04
  dependencies:
    - build
    - review:mr
  only:
    - merge_requests
  script:
    - |
      if [ -f mr-review.md ]; then
        # è½¬æ¢ä¸º GitLab Code Quality æ ¼å¼
        cat > gl-code-quality-report.json << 'EOF'
        []
        EOF

        # æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡é—®é¢˜
        if grep -q "ðŸš¨ CRITICAL\|âš ï¸  HIGH" mr-review.md; then
          echo "âš ï¸  å‘çŽ°ä¸¥é‡æˆ–é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼"
          echo "è¯·æŸ¥çœ‹ mr-review.md äº†è§£è¯¦æƒ…"
        else
          echo "âœ… æœªå‘çŽ°ä¸¥é‡é—®é¢˜"
        fi
      fi
  artifacts:
    reports:
      codequality: gl-code-quality-report.json

# å®‰å…¨æ‰«æ (ä»…æ±¡ç‚¹åˆ†æž)
security:
  stage: review
  image: ubuntu:22.04
  dependencies:
    - build
  only:
    - merge_requests
    - main
    - master
    - develop
  script:
    - ./build/cpp-agent scan . --std=$CPP_STANDARD --enable-taint-analysis --severity-filter=CRITICAL,HIGH
  artifacts:
    paths:
      - security-report.txt
    expire_in: 30 days
  allow_failure: true
