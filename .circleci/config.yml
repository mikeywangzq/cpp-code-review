# CircleCI é…ç½®
# è‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥æµç¨‹

version: 2.1

# å®šä¹‰æ‰§è¡Œå™¨
executors:
  cpp-executor:
    docker:
      - image: ubuntu:22.04
    resource_class: medium
    working_directory: ~/project

# å®šä¹‰ä½œä¸š
jobs:
  build:
    executor: cpp-executor
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "CMakeLists.txt" }}
            - v1-dependencies-

      - run:
          name: å®‰è£…ä¾èµ–
          command: |
            apt-get update -qq
            apt-get install -y build-essential cmake \
              llvm-14 llvm-14-dev clang-14 libclang-14-dev \
              libcurl4-openssl-dev git

      - run:
          name: æ„å»ºé¡¹ç›®
          command: |
            mkdir -p build
            cd build
            cmake .. -DENABLE_CURL=ON -DCMAKE_BUILD_TYPE=Release
            make -j$(nproc)

      - save_cache:
          paths:
            - build
          key: v1-dependencies-{{ checksum "CMakeLists.txt" }}

      - persist_to_workspace:
          root: .
          paths:
            - build/cpp-agent

  code-review:
    executor: cpp-executor
    steps:
      - checkout

      - attach_workspace:
          at: .

      - run:
          name: ä»£ç å®¡æŸ¥
          command: |
            # æ£€æŸ¥æ˜¯å¦ä¸º PR
            if [ -n "$CIRCLE_PULL_REQUEST" ]; then
              MODE="--pr --pr-comment=pr-review.md"
            else
              MODE="--incremental"
            fi

            # æ±¡ç‚¹åˆ†ææ ‡å¿—
            TAINT_FLAG=""
            if [ "${ENABLE_TAINT_ANALYSIS:-true}" = "true" ]; then
              TAINT_FLAG="--enable-taint-analysis"
            fi

            # AI æ ‡å¿—
            AI_FLAGS=""
            if [ "${ENABLE_AI_SUGGESTIONS:-false}" = "true" ]; then
              AI_FLAGS="--enable-ai --ai-provider=${AI_PROVIDER:-rule-based}"
              if [ -n "$OPENAI_API_KEY" ]; then
                AI_FLAGS="$AI_FLAGS --openai-key=$OPENAI_API_KEY"
              fi
              if [ -n "$ANTHROPIC_API_KEY" ]; then
                AI_FLAGS="$AI_FLAGS --anthropic-key=$ANTHROPIC_API_KEY"
              fi
            fi

            ./build/cpp-agent $MODE --std=${CPP_STANDARD:-c++17} $TAINT_FLAG $AI_FLAGS

      - run:
          name: æ£€æŸ¥ä¸¥é‡é—®é¢˜
          command: |
            if [ -f pr-review.md ]; then
              if grep -q "CRITICAL\|HIGH" pr-review.md; then
                echo "âš ï¸  å‘ç°ä¸¥é‡æˆ–é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼"
                cat pr-review.md
                exit 1
              fi
            fi

      - store_artifacts:
          path: pr-review.md
          destination: reviews/

  security-scan:
    executor: cpp-executor
    steps:
      - checkout

      - attach_workspace:
          at: .

      - run:
          name: å®‰å…¨æ‰«æ (æ±¡ç‚¹åˆ†æ)
          command: |
            ./build/cpp-agent scan . \
              --std=${CPP_STANDARD:-c++17} \
              --enable-taint-analysis \
              --severity-filter=CRITICAL,HIGH \
              > security-report.txt || true

      - run:
          name: åˆ†æå®‰å…¨æŠ¥å‘Š
          command: |
            if [ -f security-report.txt ]; then
              echo "ğŸ“Š å®‰å…¨æ‰«ææŠ¥å‘Š:"
              cat security-report.txt

              # æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨é—®é¢˜
              if grep -q "CRITICAL\|HIGH" security-report.txt; then
                echo "âš ï¸  å‘ç°å®‰å…¨æ¼æ´ï¼"
                exit 1
              else
                echo "âœ… æœªå‘ç°å®‰å…¨æ¼æ´"
              fi
            fi

      - store_artifacts:
          path: security-report.txt
          destination: security/

  generate-report:
    executor: cpp-executor
    steps:
      - checkout

      - attach_workspace:
          at: .

      - run:
          name: ç”Ÿæˆ HTML æŠ¥å‘Š
          command: |
            ./build/cpp-agent scan . \
              --std=${CPP_STANDARD:-c++17} \
              --html-output=code-review-report.html

      - store_artifacts:
          path: code-review-report.html
          destination: reports/

# å®šä¹‰å·¥ä½œæµ
workflows:
  version: 2
  main:
    jobs:
      - build

      - code-review:
          requires:
            - build

      - security-scan:
          requires:
            - build
          filters:
            branches:
              only:
                - main
                - master
                - develop

      - generate-report:
          requires:
            - build
          filters:
            branches:
              only:
                - main
                - master

  # å®šæ—¶å…¨é‡æ‰«æ (æ¯å‘¨ä¸€æ¬¡)
  scheduled:
    triggers:
      - schedule:
          cron: "0 0 * * 0"  # æ¯å‘¨æ—¥åˆå¤œ
          filters:
            branches:
              only:
                - main
                - master
    jobs:
      - build
      - security-scan:
          requires:
            - build
      - generate-report:
          requires:
            - build
