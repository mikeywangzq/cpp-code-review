# GitHub Actions å·¥ä½œæµ
# åœ¨ PR å’Œ Push æ—¶è‡ªåŠ¨è¿è¡Œä»£ç å®¡æŸ¥

name: C++ Code Review

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - '**.cpp'
      - '**.h'
      - '**.cc'
      - '**.hpp'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - '**.cpp'
      - '**.h'
      - '**.cc'
      - '**.hpp'

jobs:
  code-review:
    name: ä»£ç å®¡æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥æ”¯æŒå¢é‡åˆ†æ

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake llvm-14 llvm-14-dev clang-14 libclang-14-dev libcurl4-openssl-dev

    - name: æ„å»º cpp-agent
      run: |
        mkdir -p build
        cd build
        cmake .. -DENABLE_CURL=ON
        make -j$(nproc)

    - name: è¿è¡Œä»£ç å®¡æŸ¥ (PR æ¨¡å¼)
      if: github.event_name == 'pull_request'
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        ./build/cpp-agent --pr --pr-comment=pr-review.md --enable-taint-analysis --std=c++17

    - name: è¿è¡Œä»£ç å®¡æŸ¥ (å¢é‡æ¨¡å¼)
      if: github.event_name == 'push'
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        ./build/cpp-agent --incremental --enable-taint-analysis --std=c++17

    - name: ä¸Šä¼  PR è¯„è®º
      if: github.event_name == 'pull_request' && hashFiles('pr-review.md') != ''
      uses: actions/upload-artifact@v3
      with:
        name: pr-review
        path: pr-review.md

    - name: å‘å¸ƒ PR è¯„è®º
      if: github.event_name == 'pull_request' && hashFiles('pr-review.md') != ''
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const comment = fs.readFileSync('pr-review.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: æ£€æŸ¥å…³é”®é—®é¢˜
      run: |
        if [ -f "pr-review.md" ]; then
          if grep -q "CRITICAL\|HIGH" pr-review.md; then
            echo "âš ï¸  å‘ç°ä¸¥é‡æˆ–é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼"
            exit 1
          fi
        fi

  auto-fix:
    name: è‡ªåŠ¨ä¿®å¤ (å¯é€‰)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        ref: ${{ github.head_ref }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake llvm-14 llvm-14-dev clang-14 libclang-14-dev

    - name: æ„å»º cpp-agent
      run: |
        mkdir -p build
        cd build
        cmake ..
        make -j$(nproc)

    - name: è¿è¡Œè‡ªåŠ¨ä¿®å¤
      run: |
        ./build/cpp-agent --incremental --auto-fix --backup

    - name: æäº¤ä¿®å¤
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add -A
        git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜ [skip ci]"
        git push
